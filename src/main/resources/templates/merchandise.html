<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		
		<!-- Required meta tags -->
	    <meta charset="utf-8">
	    <meta name="viewport" content="width=device-width, initial-scale=1">
	
	    <!-- Bootstrap CSS -->
	    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
		<!-- custom CSS and JS -->
		<script src="/js/userData.js"></script>
		<link href="/css/custom.css" rel="stylesheet" />
		
		<!-- Google Fonts -->
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
		<!-- Script -->
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		
		<title>BOBO&QUOKKA</title>
	</head>
	<body>
		<!-- menu -->
		<div th:insert="~{mngtMenu}"></div>
		<div class="container mt-4">
			<div class="row justify-content-center">
				<div class="text-style">
					Merchandise List
				</div>
				<div class="mb-4">
					<table class="table table-bordered">
					  <thead>
					    <tr>
					      <th style="width: 10%;">é¸å–</th>
					      <th style="width: 20%;" scope="col">MERCHANDISE ID</th>
					      <th style="width: 20%;" scope="col">NAME</th>
					      <th style="width: 10%;" scope="col">PRICE</th>
					      <th style="width: 10%;" scope="col">QTY</th>
					      <th style="width: 30%;" scope="col">URL</th>
					    </tr>
					  </thead>
					  <tbody th:each="merchandise : ${merchandiseList}">
					    <tr>
					      <td><input type="checkbox" class="row-checkbox"></td>
					      <td data-name="id" th:text="${merchandise.id}">ID</th>
					      <td class="editable" data-name="name" th:text="${merchandise.name}">NAME</td>
					      <td class="editable" data-name="price" th:text="${merchandise.price}">PRICE</td>
					      <td class="editable" data-name="qty" th:text="${merchandise.qty}">QTY</td>
					      <td class="editable" data-name="url" th:text="${merchandise.imgurl}">URL</td>
					    </tr>
					  </tbody>
					</table>
				</div>
				<!-- è®“æŒ‰éˆ•èˆ‡è¡¨æ ¼å³å°é½Š -->
		        <div class="button-right d-flex justify-content-end mt-2">
		        	<button class="btn btn-sm btn-secondary create-btn">æ–°å¢</button>
		            <button class="btn btn-sm btn-success save-btn ms-2" disabled>å„²å­˜</button>
		            <button class="btn btn-sm btn-danger delete-btn ms-2">åˆªé™¤</button>
		        </div>
			</div>
		</div>
		<!-- Option 1: Bootstrap Bundle with Popper -->
	    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
		
	</body>
	<script>
        $(document).ready(function () {
            $(".row-checkbox").on("change", function () {
                let row = $(this).closest("tr");
                let isChecked = $(this).prop("checked");

                row.find(".editable").each(function () {
                    let text = $(this).text();
                    let fieldName = $(this).data("name");

                    if (isChecked) {
                        $(this).html(`<input type="text" class="form-control" name="${fieldName}" value="${text}">`);
                    } else {
                        let inputVal = $(this).find("input").val();
                        $(this).text(inputVal);
                    }
                });

                $(".save-btn").prop("disabled", !isChecked);
            });

            $(".save-btn").on("click", function () {
                let row = $("tbody tr").has(".row-checkbox:checked");
                let formData = {};

                row.find("td, th").each(function () {
                    let fieldName = $(this).data("name");  // å–å¾— data-name å±¬æ€§
                    let inputField = $(this).find("input"); // å˜—è©¦æ‰¾åˆ° input
                    let value = inputField.length ? inputField.val() : $(this).text(); // è‹¥æœ‰ inputï¼Œå–å€¼ï¼Œå¦å‰‡å– text

                    if (fieldName) {  // ç¢ºä¿æ¬„ä½åç¨±æœ‰æ•ˆ
                        formData[fieldName] = value;
                    }
                });

                console.log("ç™¼é€è³‡æ–™:", formData);
                
                if (formData["id"]){
                	$.ajax({
                        url: "/merchandise/save",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(formData),
                        success: function (response) {
                        	if (response.status === "success") {
                                alert("è³‡æ–™æ›´æ–°æˆåŠŸï¼");
                                window.location.reload(); // ğŸ”„ é‡æ–°æ•´ç†é é¢
                            } else {
                                alert("éŒ¯èª¤ï¼š" + response.message);
                            }
                        },
                        error: function () {
                            alert("ç™¼é€è«‹æ±‚å¤±æ•—");
                        }
                    });
                }else{
                	$.ajax({
                        url: "/merchandise/create",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(formData),
                        success: function (response) {
                        	if (response.status === "success") {
                                alert("è³‡æ–™å„²å­˜æˆåŠŸï¼");
                                window.location.reload(); // ğŸ”„ é‡æ–°æ•´ç†é é¢
                            } else {
                                alert("éŒ¯èª¤ï¼š" + response.message);
                            }
                        },
                        error: function () {
                            alert("ç™¼é€è«‹æ±‚å¤±æ•—");
                        }
                    });
                }
            });

            $(".delete-btn").on("click", function () {
                if (confirm("ç¢ºå®šè¦åˆªé™¤å•†å“å—ï¼Ÿ")) {
                	let row = $("tbody tr").has(".row-checkbox:checked");
                    let formData = {};

                    row.find("td, th").each(function () {
                        let fieldName = $(this).data("name");  // å–å¾— data-name å±¬æ€§
                        let inputField = $(this).find("input"); // å˜—è©¦æ‰¾åˆ° input
                        let value = inputField.length ? inputField.val() : $(this).text(); // è‹¥æœ‰ inputï¼Œå–å€¼ï¼Œå¦å‰‡å– text

                        if (fieldName) {  // ç¢ºä¿æ¬„ä½åç¨±æœ‰æ•ˆ
                            formData[fieldName] = value;
                        }
                    });

                    console.log("ç™¼é€è³‡æ–™:", formData);

                    $.ajax({
                        url: "/merchandise/delete",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(formData),
                        success: function (response) {
                            alert("è³‡æ–™å·²åˆªé™¤ï¼");
                            $("tbody tr").has(".row-checkbox:checked").remove();
                        }
                    });
                }
            });
            
            $(".create-btn").on("click", function () {
                let newRow = `
                	 <tr>
                        <td><input type="checkbox" class="row-checkbox" checked></td>
                        <td data-name="id"><input type="text" class="form-control" disabled name="id"></td>
                        <td data-name="name"><input type="text" class="form-control" name="name"></td>
                        <td data-name="price"><input type="text" class="form-control" name="price"></td>
                        <td data-name="qty"><input type="text" class="form-control" name="qty"></td>
                        <td data-name="url"><input type="text" class="form-control" name="url"></td>
                     </tr>
                `;

             	// **åªé¸æ“‡æœ€å¾Œä¸€å€‹ tbodyï¼Œé¿å…å¤šæ¬¡æ–°å¢**
                $("tbody").last().append(newRow);
                $(".save-btn").prop("disabled", false);
            });
            
        });
    </script>
</html>